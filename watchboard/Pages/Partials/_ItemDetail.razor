@using WatchBoard.Database.Entities
<div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" hx-put="/app/items/@(ItemModel.Id)" hx-target="#card-@(ItemModel.Id)" hx-swap="outerHTML">
        <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">
                @if (ItemModel.Type == ItemType.Tv)
                {
                    <span>
                        <i class="bi bi-collection-play"></i> @ItemModel.Name
                    </span>
                }
                else
                {
                    <span>
                        <i class="bi bi-film"></i> @ItemModel.Name <span class="text-muted fs-6 fw-bold">(@(ItemModel.ReleaseDates()))</span>
                    </span>
                }

            </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-tab-@(ItemModel.Id)" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                        Details
                    </button>
                </li>
                @if (ItemModel.Type == ItemType.Tv)
                {
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="episodes-tab" data-bs-toggle="tab" data-bs-target="#episodes-tab-@(ItemModel.Id)" type="button" role="tab" aria-controls="episodes-tab-pane" aria-selected="false">
                            Latest Episodes
                        </button>
                    </li>
                }
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="provider-tab" data-bs-toggle="tab" data-bs-target="#provider-tab-@(ItemModel.Id)" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">
                        Watch Options
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images-tab-@(ItemModel.Id)" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">
                        Images
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-tab-@(ItemModel.Id)" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">
                        Other
                    </button>
                </li>
            </ul>
            <div class="tab-content pt-2 px-2" id="myTabContent">
                <div class="tab-pane fade show active" id="details-tab-@(ItemModel.Id)" role="tabpanel" aria-labelledby="details-tab-@(ItemModel.Id)" tabindex="0">
                    <div class="pt-3 px-2">

                        @if (ItemModel.Type == ItemType.Tv)
                        {
                            <p>
                                @ItemModel.ReleaseDates()
                                <br/>
                                Status: @ItemModel.SeriesStatus
                                <br/>
                            </p>
                        }

                        @if (ItemModel.SeriesStatus == SeriesStatus.InProgress)
                        {
                            @if (ItemModel.SeriesNextEpisodeNumber == 1)
                            {
                                <p>
                                    Season @(ItemModel.SeriesNextEpisodeSeason) starts @ItemModel.SeriesNextEpisodeDate
                                </p>
                            }
                            else
                            {
                                <p class="text-body-secondary">
                                    <i class="bi bi-info-circle"></i>
                                    S@(ItemModel.SeriesNextEpisodeSeason) E@(ItemModel.SeriesNextEpisodeNumber) premieres
                                    on @ItemModel.SeriesNextEpisodeDate
                                </p>
                            }
                        }

                        <p class="fw-bold text-uppercase">Overview</p>
                        @if (ItemModel.OriginalLanguage != "EN")
                        {
                            <p class="text-muted small">
                                Language: @ItemModel.OriginalLanguage / Country: @ItemModel.OriginCountry
                            </p>
                        }
                        <p>
                            @ItemModel.Overview
                        </p>

                        <p class="fw-bold text-uppercase">Top Cast</p>
                        <div class="row mb-4">
                            @foreach (var c in ItemModel.GetCredits().Cast.OrderBy(x => x.Order).Take(6))
                            {
                                <div class="col-6 border-bottom border-secondary-subtle">
                                    <i class="bi bi-person"></i> @c.Name</div>
                                <div class="col-6 border-bottom border-secondary-subtle text-end">@c.Character</div>
                            }
                        </div>

                        <p class="fw-bold text-uppercase">Crew</p>
                        <div class="row mb-4">
                            @foreach (var c in ItemModel.GetCredits().Crew
                                              .Where(x => x.Job != null &&
                                                          (x.Job.Equals("Director", StringComparison.OrdinalIgnoreCase)
                                                           || x.Job.Equals("Writer", StringComparison.OrdinalIgnoreCase)
                                                           || (ItemModel.Type == ItemType.Tv && x.Job.Equals("Producer", StringComparison.OrdinalIgnoreCase)))).Take(6))
                            {
                                <div class="col-6 border-bottom border-secondary-subtle">
                                    <i class="bi bi-camera-video"></i> @c.Name</div>
                                <div class="col-6 border-bottom border-secondary-subtle text-end">@c.Job</div>
                            }
                        </div>
                    </div>
                </div>
                @if (ItemModel.Type == ItemType.Tv)
                {
                    <div class="tab-pane fade" id="episodes-tab-@(ItemModel.Id)" role="tabpanel" aria-labelledby="episodes-tab-@(ItemModel.Id)" tabindex="0">
                        <div class="pt-3 px-2">
                            <table class="table table-sm table-striped">
                                <thead>
                                <tr>
                                    <th scope="col">Air Date</th>
                                    <th scope="col">Episode</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Type</th>
                                </tr>
                                </thead>
                                @foreach (var season in ItemModel.GetSeasons().OrderByDescending(x => x.SeasonNumber).Take(1))
                                {
                                    @if (season.Episodes.Count <= 0)
                                    {
                                        continue;
                                    }

                                    @foreach (var e in season.Episodes.OrderByDescending(x => x.EpisodeNumber).Take(10))
                                    {
                                        <tr>
                                            <td>
                                                @e.AirDate
                                            </td>
                                            <td nowrap>
                                                S@(e.SeasonNumber.ToString("00")) E@(e.EpisodeNumber.ToString("00"))
                                            </td>
                                            <td>
                                                @e.Name
                                            </td>
                                            <td>
                                                @e.EpisodeType
                                            </td>
                                        </tr>
                                    }
                                }
                            </table>
                        </div>
                    </div>
                }
                <div class="tab-pane fade" id="provider-tab-@(ItemModel.Id)" role="tabpanel" aria-labelledby="provider-tab-@(ItemModel.Id)" tabindex="0">
                    <div class="pt-3 px-2">
                        @foreach (var providerOption in ItemModel.GetProviders())
                        {
                            <div class="form-check">
                                @if (providerOption.Selected)
                                {
                                    <input onchange="enableItemDetailSubmitBtn()" class="form-check-input" type="radio" id="selectedProviderId-@(providerOption.Id)" name="selectedProvider" value="@(providerOption.Id)" checked>
                                }
                                else
                                {
                                    <input onchange="enableItemDetailSubmitBtn()" class="form-check-input" type="radio" id="selectedProviderId-@(providerOption.Id)" name="selectedProvider" value="@(providerOption.Id)">
                                }
                                <label class="form-check-label" for="selectedProviderId-@(providerOption.Id)">
                                    @providerOption.Name
                                </label>
                            </div>
                        }
                        <div class="mt-3 fw-lighter" style="font-size: 0.8em;">
                            Watch provider data supplied by <a href="https://www.justwatch.com/">JustWatch</a>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="images-tab-@(ItemModel.Id)" role="tabpanel" aria-labelledby="images-tab-@(ItemModel.Id)" tabindex="0">
                    <div class="pt-3 px-2">

                        <div class="d-flex gap-3">
                            <div>
                                @foreach (var i in ItemModel.GetBackdropImages().OrderByDescending(x => x.VoteCount).ThenByDescending(x => x.VoteAverage).Take(12))
                                {
                                    <div class="form-check" hx-indicator="#img-thumbnail-spinner">
                                        @if (i.UrlPath == ItemModel.BackdropUrl)
                                        {
                                            <input hx-get="/app/items/@(ItemModel.Id)/backdrops/@(i.Id)" hx-target="#backdrop-thumbnail" hx-swap="innerHTML" onchange="enableItemDetailSubmitBtn()" class="form-check-input" type="radio" name="selectedImage" id="selectedImageId-@(i.Id)" value="@(i.Id)" checked>
                                        }
                                        else
                                        {
                                            <input hx-get="/app/items/@(ItemModel.Id)/backdrops/@(i.Id)" hx-target="#backdrop-thumbnail" hx-swap="innerHTML" onchange="enableItemDetailSubmitBtn()" class="form-check-input" type="radio" name="selectedImage" id="selectedImageId-@(i.Id)" value="@(i.Id)"/>
                                        }
                                        <label class="form-check-label" for="selectedImageId-@(i.Id)">
                                            <i class="bi bi-image"></i> votes: @i.VoteCount / avg: @i.VoteAverage
                                        </label>
                                    </div>
                                }
                            </div>

                            <div class="position-relative">
                                <div id="backdrop-thumbnail">
                                    <img class="img-thumbnail" src="@(ItemModel.BackdropBase64)" width="200" height="112" alt="@ItemModel.Name"/>
                                </div>
                                <div class="htmx-indicator position-absolute top-0 start-0 ms-3 mt-3" id="img-thumbnail-spinner">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 fw-lighter" style="font-size: 0.8em;">
                            Image data supplied by <a href="https://developer.themoviedb.org">TMDB</a>
                        </div>

                    </div>
                </div>
                <div class="tab-pane fade" id="settings-tab-@(ItemModel.Id)" role="tabpanel" aria-labelledby="settings-tab-@(ItemModel.Id)" tabindex="0">
                    <div class="pt-3 px-2">
                        <button class="btn btn-link link-light link-underline link-underline-opacity-0" hx-put="/app/items/@(ItemModel.Id)/refresh" hx-target="#card-@(ItemModel.Id)" hx-params="none" hx-swap="outerHTML">
                            <i class="bi bi-download me-2"></i>Refresh Metadata from TMDB
                            <div class="htmx-indicator ms-3 spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </div>
                    <div class="pt-1 px-2">
                        @foreach (var b in Boards)
                        {
                            <button hx-put="/app/items/@(ItemModel.Id)/move/@(b.Id)" hx-swap="delete swap:1s" hx-target="#card-@(ItemModel.Id)" type="button" class="btn btn-link link-light link-underline link-underline-opacity-0">
                                Move <i class="bi bi-arrow-right me-2"></i> <strong>@(b.Name)</strong>
                            </button>
                            <br/>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-danger" hx-swap="delete swap:1s" hx-target="#card-@(ItemModel.Id)" hx-params="none" hx-delete="/app/items/@(ItemModel.Id)" data-bs-dismiss="modal">
                Remove
            </button>
            <a class="btn btn-link" href="@(ItemModel.ImdbUrl)">
                IMDB <i class="ms-1 bi bi-arrow-up-right-square"></i>
            </a>
            <div>
                <button type="submit" id="itemDetailSubmitBtn" class="btn btn-primary me-2" data-bs-dismiss="modal" disabled>
                    Save Changes
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </form>
</div>

@code {

    [Parameter]
    public Item ItemModel { get; set; } = new();

    [Parameter]
    public List<Board> Boards { get; set; } = [];

    private ItemProvider? SelectedProvider => ItemModel.GetProviders().FirstOrDefault(x => x.Selected);
    
    private string ProviderSvg(string providerName)
    {
        if (providerName.Contains("Amazon", StringComparison.OrdinalIgnoreCase))
        {
            return "M15.6262 14.6201C14.5191 16.2386 12.8976 17.0042 11.0007 17.0042C8.69659 17.0042 6.7243 15.2315 7.00788 12.8803C7.32248 10.272 9.34731 9.14962 12.716 8.73726C13.3171 8.66367 13.566 8.64299 14.8629 8.54691C14.9116 8.54331 14.9575 8.53988 15.001 8.5366C15.0008 8.46544 15.0007 8.39386 15.0007 8.32185C15.0007 6.52595 13.9328 5.30005 12.5007 5.30005C11.0638 5.30005 10.0603 6.0474 9.44592 7.82645L7.55546 7.17365C8.44288 4.60377 10.1935 3.30005 12.5007 3.30005C15.1034 3.30005 17.0007 5.47803 17.0007 8.32185C17.0007 10.9707 17.164 13.0776 17.484 13.8794C17.84 14.7715 17.9698 14.9959 18.3677 15.4921L16.8075 16.7434C16.2843 16.091 16.0549 15.6945 15.6264 14.6207L15.6262 14.6201ZM21.2572 20.5453C20.9864 20.7452 20.5157 20.6263 20.7288 20.1048C20.9934 19.4569 21.2755 18.6971 20.9911 18.3527C20.7807 18.098 20.5235 17.9711 19.9637 17.9711C19.5041 17.9711 19.2733 18.0305 18.9688 18.0508C18.7646 18.0645 18.6753 17.7537 18.8775 17.6109C19.1393 17.426 19.4216 17.2811 19.7483 17.1833C20.8979 16.8389 22.253 17.0276 22.4172 17.2658C22.7826 17.7959 22.2189 19.835 21.2572 20.5453ZM20.0754 19.4608C19.8136 19.7164 19.5299 19.9496 19.2462 20.156C17.1235 21.7716 14.3748 22.6169 11.9875 22.6169C8.14505 22.6169 4.70765 20.8226 2.10014 17.8212C1.87644 17.5906 2.06133 17.2555 2.32314 17.4369C5.13247 19.5136 8.6108 20.7699 12.2112 20.7699C14.4772 20.7699 16.9195 20.2329 19.2462 19.0775C19.4085 19.0007 19.5906 18.8961 19.7501 18.8228C20.117 18.6128 20.4395 19.1293 20.0754 19.4608ZM15.0107 10.5414C13.7522 10.6347 13.5147 10.6544 12.959 10.7224C10.4062 11.0349 9.16175 11.7247 8.99349 13.1198C8.86763 14.1633 9.80321 15.0042 11.0007 15.0042C13.0397 15.0042 14.5179 13.7764 15.0227 10.5406C15.0187 10.5409 15.0147 10.5411 15.0107 10.5414Z";
        }

        if (providerName.Contains("Netflix", StringComparison.OrdinalIgnoreCase))
        {
            return "M15.9853 17.2079L16.001 2H18.001V22C17.3209 21.7333 16.6476 21.5667 15.9809 21.5L8.00098 6.30216V21.5C7.33431 21.5667 6.66764 21.7333 6.00098 22V2H8.00098L15.9853 17.2079Z";
        }

        if (providerName.Contains("Apple", StringComparison.OrdinalIgnoreCase))
        {
            return "M15.778 8.20793C15.3053 8.1711 14.7974 8.28434 14.0197 8.58067C14.085 8.55577 13.2775 8.87173 13.0511 8.95077C12.5494 9.12593 12.1364 9.22198 11.6734 9.22198C11.2151 9.22198 10.7925 9.13042 10.3078 8.96683C10.1524 8.91441 9.99616 8.8564 9.80283 8.7809C9.71993 8.74852 9.41997 8.62947 9.3544 8.60379C8.70626 8.34996 8.34154 8.25434 8.03885 8.26181C6.88626 8.2765 5.79557 8.9421 5.16246 10.0442C3.87037 12.2875 4.58583 16.3428 6.47459 19.075C7.4802 20.5189 8.03062 21.035 8.25199 21.0279C8.4743 21.0183 8.63777 20.9713 9.03567 20.8026C9.11485 20.7689 9.11485 20.7689 9.202 20.7317C10.2077 20.3032 10.9118 20.114 11.9734 20.114C12.9944 20.114 13.6763 20.2997 14.6416 20.7159C14.7302 20.7542 14.7302 20.7542 14.8097 20.7884C15.2074 20.9588 15.3509 20.9962 15.6016 20.9902C15.9591 20.9846 16.4003 20.5726 17.3791 19.1362C17.6471 18.7447 17.884 18.3333 18.0895 17.9168C17.9573 17.8077 17.826 17.6917 17.6975 17.5693C16.4086 16.3408 15.6114 14.6845 15.5895 12.6391C15.5756 11.0186 16.1057 9.61487 16.999 8.45797C16.6293 8.3142 16.2216 8.23805 15.778 8.20793ZM15.9334 6.21398C16.6414 6.26198 18.6694 6.47798 19.9894 8.40998C19.8814 8.46998 17.5654 9.81397 17.5894 12.622C17.6254 15.982 20.5294 17.098 20.5654 17.11C20.5414 17.194 20.0974 18.706 19.0294 20.266C18.1054 21.622 17.1454 22.966 15.6334 22.99C14.1454 23.026 13.6654 22.114 11.9734 22.114C10.2694 22.114 9.74138 22.966 8.33738 23.026C6.87338 23.074 5.76938 21.562 4.83338 20.218C2.92538 17.458 1.47338 12.442 3.42938 9.04597C4.40138 7.35397 6.12938 6.28598 8.01338 6.26198C9.44138 6.22598 10.7974 7.22198 11.6734 7.22198C12.5374 7.22198 14.0854 6.06998 15.9334 6.21398ZM14.7934 4.38998C14.0134 5.32598 12.7414 6.05798 11.5054 5.96198C11.3374 4.68998 11.9614 3.35798 12.6814 2.52998C13.4854 1.59398 14.8294 0.897976 15.9454 0.849976C16.0894 2.14598 15.5734 3.45398 14.7934 4.38998Z";
        }

        if (providerName.Contains("Servarr", StringComparison.OrdinalIgnoreCase) || providerName.Contains("Home", StringComparison.OrdinalIgnoreCase))
        {
            return "bi bi-download";
        }

        if (providerName.Contains("Television", StringComparison.OrdinalIgnoreCase))
        {
            return "bi bi-tv";
        }

        return "bi bi-dot opacity-0";
    }
}